Subject: [PATCH] 2_service_layer_3_HWD3
---
Index: src/main/java/ru/javaops/cloudjava/ordersservice/mapper/OrderMapper.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ru/javaops/cloudjava/ordersservice/mapper/OrderMapper.java b/src/main/java/ru/javaops/cloudjava/ordersservice/mapper/OrderMapper.java
--- a/src/main/java/ru/javaops/cloudjava/ordersservice/mapper/OrderMapper.java	(revision fb59e3bbbb96d9c97d93652b0f186d3d226cbdc5)
+++ b/src/main/java/ru/javaops/cloudjava/ordersservice/mapper/OrderMapper.java	(revision 8bbb023a3768b9ca5a5ddbd5eb72065a92fcb66d)
@@ -1,10 +1,15 @@
 package ru.javaops.cloudjava.ordersservice.mapper;
 
+import org.springframework.http.HttpStatus;
 import org.springframework.stereotype.Component;
-import ru.javaops.cloudjava.ordersservice.dto.CreateOrderRequest;
-import ru.javaops.cloudjava.ordersservice.dto.GetMenuInfoResponse;
-import ru.javaops.cloudjava.ordersservice.dto.OrderResponse;
+import ru.javaops.cloudjava.ordersservice.dto.*;
+import ru.javaops.cloudjava.ordersservice.exception.OrderServiceException;
+import ru.javaops.cloudjava.ordersservice.storage.model.MenuLineItem;
 import ru.javaops.cloudjava.ordersservice.storage.model.MenuOrder;
+import ru.javaops.cloudjava.ordersservice.storage.model.OrderStatus;
+
+import java.math.BigDecimal;
+import java.util.List;
 
 @Component
 public class OrderMapper {
@@ -12,12 +17,64 @@
     public MenuOrder mapToOrder(CreateOrderRequest request,
                                 String username,
                                 GetMenuInfoResponse infoResponse) {
-        // TODO
-        return null;
+        var infos = infoResponse.getMenuInfos();
+        throwIfHasUnavailableMenuItems(infos);
+
+        List<MenuLineItem> menuLineItems = getMenuLineItems(request, infos);
+        var totalPrice = calculateTotalPrice(menuLineItems);
+
+        return MenuOrder.builder()
+                .totalPrice(totalPrice)
+                .city(request.getAddress().getCity())
+                .street(request.getAddress().getStreet())
+                .house(request.getAddress().getHouse())
+                .apartment(request.getAddress().getApartment())
+                .status(OrderStatus.NEW)
+                .createdBy(username)
+                .menuLineItems(menuLineItems)
+                .build();
     }
 
     public OrderResponse mapToResponse(MenuOrder order) {
-        // TODO
-        return null;
+        return OrderResponse.builder()
+                .orderId(order.getId())
+                .totalPrice(order.getTotalPrice())
+                .menuLineItems(order.getMenuLineItems())
+                .address(Address.builder()
+                        .city(order.getCity())
+                        .street(order.getStreet())
+                        .house(order.getHouse())
+                        .apartment(order.getApartment())
+                        .build())
+                .status(order.getStatus())
+                .createdAt(order.getCreatedAt())
+                .build();
+    }
+
+    private void throwIfHasUnavailableMenuItems(List<MenuInfo> infos) {
+        boolean hasUnavailable = infos.stream().anyMatch(m -> !m.getIsAvailable());
+        if (hasUnavailable) {
+            var msg = String.format("Cannot create order, because some menu items are not available: %s",
+                    infos);
+            throw new OrderServiceException(msg, HttpStatus.NOT_FOUND);
+        }
+    }
+
+    private List<MenuLineItem> getMenuLineItems(CreateOrderRequest request, List<MenuInfo> infos) {
+        return infos.stream()
+                .map(info -> {
+                    int quantity = request.getNameToQuantity().get(info.getName());
+                    return MenuLineItem.builder()
+                            .menuItemName(info.getName())
+                            .price(info.getPrice())
+                            .quantity(quantity)
+                            .build();
+                }).toList();
+    }
+
+    private BigDecimal calculateTotalPrice(List<MenuLineItem> menuLineItems) {
+        return menuLineItems.stream()
+                .map(mi -> mi.getPrice().multiply(BigDecimal.valueOf(mi.getQuantity())))
+                .reduce(BigDecimal.ZERO, BigDecimal::add);
     }
 }
Index: src/main/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImpl.java b/src/main/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImpl.java
--- a/src/main/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImpl.java	(revision fb59e3bbbb96d9c97d93652b0f186d3d226cbdc5)
+++ b/src/main/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImpl.java	(revision 8bbb023a3768b9ca5a5ddbd5eb72065a92fcb66d)
@@ -1,11 +1,13 @@
 package ru.javaops.cloudjava.ordersservice.service.impl;
 
 import lombok.RequiredArgsConstructor;
+import org.springframework.data.domain.PageRequest;
 import org.springframework.stereotype.Service;
 import reactor.core.publisher.Flux;
 import reactor.core.publisher.Mono;
 import ru.javaops.cloudjava.ordersservice.client.MenuClient;
 import ru.javaops.cloudjava.ordersservice.dto.CreateOrderRequest;
+import ru.javaops.cloudjava.ordersservice.dto.GetMenuInfoRequest;
 import ru.javaops.cloudjava.ordersservice.dto.OrderResponse;
 import ru.javaops.cloudjava.ordersservice.dto.SortBy;
 import ru.javaops.cloudjava.ordersservice.mapper.OrderMapper;
@@ -22,22 +24,19 @@
 
     @Override
     public Mono<OrderResponse> createOrder(CreateOrderRequest request, String username) {
-        // TODO
-        // 1. получаем Mono<GetMenuInfoResponse> из Menu Service
-        // 2. маппим полученные данные и входящий запрос на сущность MenuOrder
-        // 3. сохраняем ее в базе и возвращаем Mono<MenuOrder>, чтобы избавиться от
-        // вложенности (Mono<Mono<MenuOrder>>) используем оператор flatMap
-        // 4. маппим MenuOrder на OrderResponse
-        return null;
+        var getInfoRequest = new GetMenuInfoRequest(request.getNameToQuantity().keySet());
+        return menuClient
+                .getMenuInfo(getInfoRequest)
+                .map(response -> orderMapper.mapToOrder(request, username, response))
+                .flatMap(repository::save)
+                .map(orderMapper::mapToResponse);
     }
 
     @Override
     public Flux<OrderResponse> getOrdersOfUser(String username, SortBy sortBy, int from, int size) {
-        // TODO
-        // 1. формируем PageRequest из параметров from, size
-        // 2. применяем сортировку к PageRequest
-        // 3. ищем заказы в базе данных
-        // 4. маппим MenuOrder на OrderResponse
-        return null;
+        var pageRequest = PageRequest.of(from, size)
+                .withSort(sortBy.getSort());
+        return repository.findAllByCreatedBy(username, pageRequest)
+                .map(orderMapper::mapToResponse);
     }
 }
Index: src/test/java/ru/javaops/cloudjava/ordersservice/client/MenuClientTest.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/test/java/ru/javaops/cloudjava/ordersservice/client/MenuClientTest.java b/src/test/java/ru/javaops/cloudjava/ordersservice/client/MenuClientTest.java
--- a/src/test/java/ru/javaops/cloudjava/ordersservice/client/MenuClientTest.java	(revision fb59e3bbbb96d9c97d93652b0f186d3d226cbdc5)
+++ b/src/test/java/ru/javaops/cloudjava/ordersservice/client/MenuClientTest.java	(revision 8bbb023a3768b9ca5a5ddbd5eb72065a92fcb66d)
@@ -14,6 +14,7 @@
 import ru.javaops.cloudjava.ordersservice.dto.GetMenuInfoRequest;
 import ru.javaops.cloudjava.ordersservice.dto.GetMenuInfoResponse;
 import ru.javaops.cloudjava.ordersservice.dto.MenuInfo;
+import ru.javaops.cloudjava.ordersservice.exception.OrderServiceException;
 import ru.javaops.cloudjava.ordersservice.testdata.TestDataProvider;
 
 import java.io.IOException;
@@ -55,6 +56,19 @@
         mockWebServer.shutdown();
     }
 
+    @Test
+    void getMenuInfo_returnsError_whenTimeout() throws Exception {
+        mockWebServer.enqueue(TestDataProvider.partialSuccessResponse().setBodyDelay(DELAY_MILLIS, TimeUnit.MILLISECONDS));
+
+        var request = new GetMenuInfoRequest(Set.of("One", "Two", "Three"));
+        Mono<GetMenuInfoResponse> response = menuClient.getMenuInfo(request);
+
+        StepVerifier.create(response)
+                .expectError(OrderServiceException.class)
+                .verify();
+        verifyNumberOfPostRequests(4);
+    }
+
     @Test
     void getMenuInfo_returnsInfo_whenRetriesSucceed() throws Exception {
         // на первый запрос ответ сервера - SERVICE_UNAVAILABLE
@@ -70,6 +84,18 @@
         verifyNumberOfPostRequests(3);
     }
 
+    @Test
+    void getMenuInfo_returnsErrorWhenServiceUnavailableAndAllRetriesExhausted() throws Exception {
+        mockWebServer.enqueue(new MockResponse().setResponseCode(HttpStatus.SERVICE_UNAVAILABLE.value()));
+        var request = new GetMenuInfoRequest(Set.of("One", "Two", "Three"));
+        Mono<GetMenuInfoResponse> response = menuClient.getMenuInfo(request);
+
+        StepVerifier.create(response)
+                .expectError(OrderServiceException.class)
+                .verify();
+        verifyNumberOfPostRequests(4);
+    }
+
     @Test
     void getMenuInfo_returnsInfo_whenAllIsOk() throws Exception {
         mockWebServer.enqueue(TestDataProvider.partialSuccessResponse());
Index: src/test/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImplTest.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/test/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImplTest.java b/src/test/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImplTest.java
--- a/src/test/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImplTest.java	(revision fb59e3bbbb96d9c97d93652b0f186d3d226cbdc5)
+++ b/src/test/java/ru/javaops/cloudjava/ordersservice/service/impl/MenuOrderServiceImplTest.java	(revision 8bbb023a3768b9ca5a5ddbd5eb72065a92fcb66d)
@@ -8,6 +8,7 @@
 import ru.javaops.cloudjava.ordersservice.BaseIntegrationTest;
 import ru.javaops.cloudjava.ordersservice.dto.OrderResponse;
 import ru.javaops.cloudjava.ordersservice.dto.SortBy;
+import ru.javaops.cloudjava.ordersservice.exception.OrderServiceException;
 import ru.javaops.cloudjava.ordersservice.storage.model.MenuLineItem;
 import ru.javaops.cloudjava.ordersservice.storage.model.OrderStatus;
 import ru.javaops.cloudjava.ordersservice.testdata.TestConstants;
@@ -16,8 +17,7 @@
 import java.util.ArrayList;
 import java.util.Comparator;
 
-import static com.github.tomakehurst.wiremock.client.WireMock.postRequestedFor;
-import static com.github.tomakehurst.wiremock.client.WireMock.urlEqualTo;
+import static com.github.tomakehurst.wiremock.client.WireMock.*;
 import static org.assertj.core.api.AssertionsForInterfaceTypes.assertThat;
 import static ru.javaops.cloudjava.ordersservice.testdata.TestConstants.*;
 import static ru.javaops.cloudjava.ordersservice.testdata.TestDataProvider.createOrderRequest;
@@ -38,6 +38,50 @@
                 .verifyComplete();
     }
 
+    @Test
+    void getOrdersOfUser_returnsEmptyFluxWhenNoOrders() {
+        Flux<OrderResponse> orders = menuOrderService.getOrdersOfUser("Unknown", SortBy.DATE_DESC, 0, 100);
+        StepVerifier.create(orders)
+                .expectNextCount(0)
+                .verifyComplete();
+    }
+
+    @Test
+    void createOrder_returnsError_whenServiceNotAvailable() {
+        prepareStubForServiceUnavailable();
+
+        var createOrderRequest = createOrderRequest();
+        Mono<OrderResponse> order = menuOrderService.createOrder(createOrderRequest, USERNAME_ONE);
+        StepVerifier.create(order)
+                .expectError(OrderServiceException.class)
+                .verify();
+        wiremock.verify(6, postRequestedFor(urlEqualTo(MENU_INFO_PATH)));
+    }
+
+    @Test
+    void createOrder_returnsError_whenTimeout() {
+        prepareStubForSuccessWithTimeout();
+
+        var createOrderRequest = createOrderRequest();
+        Mono<OrderResponse> order = menuOrderService.createOrder(createOrderRequest, USERNAME_ONE);
+        StepVerifier.create(order)
+                .expectError(OrderServiceException.class)
+                .verify();
+        wiremock.verify(6, postRequestedFor(urlEqualTo(MENU_INFO_PATH)));
+    }
+
+    @Test
+    void createOrder_returnsError_whenSomeMenusAreNotAvailable() {
+        prepareStubForPartialSuccess();
+
+        var createOrderRequest = createOrderRequest();
+        Mono<OrderResponse> order = menuOrderService.createOrder(createOrderRequest, USERNAME_ONE);
+        StepVerifier.create(order)
+                .expectError(OrderServiceException.class)
+                .verify();
+        wiremock.verify(1, postRequestedFor(urlEqualTo(MENU_INFO_PATH)));
+    }
+
     @Test
     void createOrder_createsOrderWhenAllMenusAreAvailable() {
         prepareStubForSuccess();
