Subject: [PATCH] 8_kafka_docker_1
---
Index: docker/.env
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/docker/.env b/docker/.env
--- a/docker/.env	(revision 703845cfc8e7a90bcd97b9ffc117987d1ae068a6)
+++ b/docker/.env	(date 1729179782659)
@@ -1,11 +1,9 @@
 CONFIG_SERVER_URL=http://config-server:9095
+MENU_SERVICE_URL=http://menu-service:9091
 
-MENU_DB_USER=user
-MENU_DB_PASSWORD=password
-MENU_DB_URL=jdbc:postgresql://postgres-menus:5431/menu_service_db
+POSTGRES_DB_USER=user
+POSTGRES_DB_PASSWORD=password
 
-ORDERS_DB_USER=user
-ORDERS_DB_PASSWORD=password
-ORDERS_DB_URL=r2dbc:postgresql://postgres-orders:5432/orders_service_db
-ORDERS_DB_FLYWAY_URL=jdbc:postgresql://postgres-orders:5432/orders_service_db
-MENU_SERVICE_URL=http://menu-service:9091
\ No newline at end of file
+MENU_DB_URL=jdbc:postgresql://postgres:5432/menu_service_db
+ORDERS_DB_URL=r2dbc:postgresql://postgres:5432/orders_service_db
+ORDERS_DB_FLYWAY_URL=jdbc:postgresql://postgres:5432/orders_service_db
Index: docker/postgresql/init.sql
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/docker/postgresql/init.sql b/docker/postgresql/init.sql
new file mode 100644
--- /dev/null	(date 1729179380581)
+++ b/docker/postgresql/init.sql	(date 1729179380581)
@@ -0,0 +1,2 @@
+CREATE DATABASE menu_service_db;
+CREATE DATABASE orders_service_db;
\ No newline at end of file
Index: docker/docker-compose.yml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/docker/docker-compose.yml b/docker/docker-compose.yml
--- a/docker/docker-compose.yml	(revision 703845cfc8e7a90bcd97b9ffc117987d1ae068a6)
+++ b/docker/docker-compose.yml	(date 1729181679660)
@@ -19,7 +19,7 @@
     image: "orders-service"
     container_name: "orders-service"
     depends_on:
-      postgres-orders:
+      postgres:
         condition: service_healthy
       config-server:
         condition: service_healthy
@@ -29,8 +29,8 @@
       - CONFIGSERVER_IMPORT=configserver:${CONFIG_SERVER_URL}
       - SPRING_CLOUD_CONFIG_FAIL_FAST=true
       - SPRING_PROFILES_ACTIVE=prod
-      - DB_USER=${ORDERS_DB_USER}
-      - DB_PASSWORD=${ORDERS_DB_PASSWORD}
+      - DB_USER=${POSTGRES_DB_USER}
+      - DB_PASSWORD=${POSTGRES_DB_PASSWORD}
       - DB_URL=${ORDERS_DB_URL}
       - FLYWAY_DB_URL=${ORDERS_DB_FLYWAY_URL}
       - MENU_SERVICE_URL=${MENU_SERVICE_URL}
@@ -39,7 +39,7 @@
     image: "menu-service"
     container_name: "menu-service"
     depends_on:
-      postgres-menus:
+      postgres:
         condition: service_healthy
       config-server:
         condition: service_healthy
@@ -49,49 +49,32 @@
       - CONFIGSERVER_IMPORT=configserver:${CONFIG_SERVER_URL}
       - SPRING_CLOUD_CONFIG_FAIL_FAST=true
       - SPRING_PROFILES_ACTIVE=prod
-      - DB_USER=${MENU_DB_USER}
-      - DB_PASSWORD=${MENU_DB_PASSWORD}
+      - DB_USER=${POSTGRES_DB_USER}
+      - DB_PASSWORD=${POSTGRES_DB_PASSWORD}
       - DB_URL=${MENU_DB_URL}
 
-  postgres-menus:
+  postgres:
     image: "postgres:16.1"
-    container_name: "postgres-menus"
-    ports:
-      - "5431:5431"
-    environment:
-      - POSTGRES_USER=${MENU_DB_USER}
-      - POSTGRES_PASSWORD=${MENU_DB_PASSWORD}
-      - POSTGRES_DB=menu_service_db
-      - PGPORT=5431
-    volumes:
-      - db-menus:/var/lib/postgresql/data
-    healthcheck:
-      test: [ "CMD-SHELL", "pg_isready", "-d", "menu_service_db"]
-      interval: 30s
-      timeout: 60s
-      retries: 5
-      start_period: 80s
-
-  postgres-orders:
-    image: "postgres:16.1"
-    container_name: "postgres-orders"
+    container_name: "postgres"
     ports:
       - "15432:5432"
     environment:
-      - POSTGRES_USER=${ORDERS_DB_USER}
-      - POSTGRES_PASSWORD=${ORDERS_DB_PASSWORD}
-      - POSTGRES_DB=orders_service_db
+      - POSTGRES_USER=${POSTGRES_DB_USER}
+      - POSTGRES_PASSWORD=${POSTGRES_DB_PASSWORD}
     volumes:
-      - db-orders:/var/lib/postgresql/data
+      - ./postgresql/init.sql:/docker-entrypoint-initdb.d/init.sql
+      - db-data:/var/lib/postgresql/data
     healthcheck:
-      test: [ "CMD-SHELL", "pg_isready", "-d", "orders_service_db" ]
+      test: [ "CMD-SHELL", "pg_isready -d menu_service_db && pg_isready -d orders_service_db" ]
       interval: 30s
       timeout: 60s
       retries: 5
       start_period: 80s
+    command: >
+      -c wal_level=logical
+      -c max_wal_senders=1
+      -c max_replication_slots=1
 
 volumes:
-  db-orders:
-    driver: local
-  db-menus:
+  db-data:
     driver: local
\ No newline at end of file
